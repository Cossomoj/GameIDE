import { Router, Request, Response } from 'express';
import { asyncHandler } from '@/middleware/errorHandler';
import { deviceTestingService } from '@/services/deviceTesting';
import { LoggerService } from '@/services/logger';
import path from 'path';

const router = Router();
const logger = new LoggerService();

// –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –Ω–∞–±–æ—Ä–∞
router.post('/suites', asyncHandler(async (req: Request, res: Response) => {
  const { gameId, gamePath, devices, customTests } = req.body;
  
  if (!gameId || !gamePath) {
    return res.status(400).json({
      success: false,
      error: '–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: gameId, gamePath'
    });
  }
  
  try {
    const suite = await deviceTestingService.createTestSuite(gameId, gamePath, {
      devices,
      customTests
    });
    
    logger.info(`üì± –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä –¥–ª—è –∏–≥—Ä—ã ${gameId}`, {
      suiteId: suite.id,
      deviceCount: suite.devices.length,
      testCount: suite.tests.length
    });
    
    res.json({
      success: true,
      data: suite,
      message: '–¢–µ—Å—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ'
    });
    
  } catch (error) {
    res.status(500).json({
      success: false,
      error: '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –Ω–∞–±–æ—Ä–∞',
      message: error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
    });
  }
}));

// –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
router.post('/suites/:suiteId/execute', asyncHandler(async (req: Request, res: Response) => {
  const { suiteId } = req.params;
  const { gamePath } = req.body;
  
  if (!gamePath) {
    return res.status(400).json({
      success: false,
      error: '–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ: gamePath'
    });
  }
  
  try {
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
    const reportPromise = deviceTestingService.executeSuite(suiteId, gamePath);
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
    res.json({
      success: true,
      message: '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ',
      suiteId,
      status: 'running'
    });
    
    // –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ–Ω–µ
    reportPromise
      .then(report => {
        logger.info(`‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ${suiteId} –∑–∞–≤–µ—Ä—à–µ–Ω–æ`, {
          score: report.summary.averageScore,
          passed: report.summary.passedDevices,
          total: report.summary.totalDevices
        });
      })
      .catch(error => {
        logger.error(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ${suiteId}:`, error);
      });
      
  } catch (error) {
    res.status(500).json({
      success: false,
      error: '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è',
      message: error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
    });
  }
}));

// –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
router.get('/reports/:executionId', asyncHandler(async (req: Request, res: Response) => {
  const { executionId } = req.params;
  
  try {
    const report = await deviceTestingService.getTestReport(executionId);
    
    if (!report) {
      return res.status(404).json({
        success: false,
        error: '–û—Ç—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'
      });
    }
    
    res.json({
      success: true,
      data: report
    });
    
  } catch (error) {
    res.status(500).json({
      success: false,
      error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞',
      message: error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
    });
  }
}));

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –æ—Ç—á–µ—Ç–æ–≤
router.get('/reports', asyncHandler(async (req: Request, res: Response) => {
  const limit = parseInt(req.query.limit as string) || 50;
  const gameId = req.query.gameId as string;
  
  try {
    const reports = await deviceTestingService.getAllReports();
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∏–≥—Ä–µ –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞
    let filteredReports = reports;
    if (gameId) {
      filteredReports = reports.filter(report => report.gameId === gameId);
    }
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
    filteredReports.sort((a, b) => b.startTime.getTime() - a.startTime.getTime());
    
    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    const limitedReports = filteredReports.slice(0, limit);
    
    res.json({
      success: true,
      data: limitedReports,
      count: limitedReports.length,
      total: filteredReports.length
    });
    
  } catch (error) {
    res.status(500).json({
      success: false,
      error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–æ–≤',
      message: error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
    });
  }
}));

// –ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–≥—Ä—ã –Ω–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
router.post('/quick-test', asyncHandler(async (req: Request, res: Response) => {
  const { gameId, gamePath } = req.body;
  
  if (!gameId || !gamePath) {
    return res.status(400).json({
      success: false,
      error: '–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: gameId, gamePath'
    });
  }
  
  try {
    // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä —Å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
    const suite = await deviceTestingService.createTestSuite(gameId, gamePath);
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    const report = await deviceTestingService.executeSuite(suite.id, gamePath);
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—É—é —Å–≤–æ–¥–∫—É
    const summary = {
      gameId,
      score: report.summary.averageScore,
      status: report.summary.averageScore >= 80 ? 'excellent' : 
              report.summary.averageScore >= 60 ? 'good' : 
              report.summary.averageScore >= 40 ? 'fair' : 'poor',
      deviceResults: report.results.map(result => ({
        device: result.deviceProfile.name,
        passed: result.success,
        fps: result.performance.averageFps,
        loadTime: result.performance.loadTime,
        errorCount: result.performance.errorCount
      })),
      recommendations: report.recommendations.filter(r => r.priority === 'high'),
      executionId: report.executionId
    };
    
    logger.info(`üöÄ –ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ${gameId} –∑–∞–≤–µ—Ä—à–µ–Ω–æ`, {
      score: summary.score,
      status: summary.status
    });
    
    res.json({
      success: true,
      data: summary,
      message: '–ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ'
    });
    
  } catch (error) {
    res.status(500).json({
      success: false,
      error: '–û—à–∏–±–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è',
      message: error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
    });
  }
}));

// –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤
router.get('/device-profiles', asyncHandler(async (req: Request, res: Response) => {
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
  const deviceProfiles = [
    {
      id: 'iphone-13',
      name: 'iPhone 13',
      type: 'mobile',
      os: 'ios',
      browser: 'safari',
      viewport: { width: 390, height: 844 },
      popular: true
    },
    {
      id: 'samsung-galaxy-s21',
      name: 'Samsung Galaxy S21',
      type: 'mobile',
      os: 'android',
      browser: 'chrome',
      viewport: { width: 360, height: 800 },
      popular: true
    },
    {
      id: 'ipad-air',
      name: 'iPad Air',
      type: 'tablet',
      os: 'ios',
      browser: 'safari',
      viewport: { width: 820, height: 1180 },
      popular: true
    },
    {
      id: 'desktop-chrome',
      name: 'Desktop Chrome',
      type: 'desktop',
      os: 'windows',
      browser: 'chrome',
      viewport: { width: 1920, height: 1080 },
      popular: true
    }
  ];
  
  res.json({
    success: true,
    data: deviceProfiles,
    count: deviceProfiles.length
  });
}));

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
router.get('/stats', asyncHandler(async (req: Request, res: Response) => {
  try {
    const reports = await deviceTestingService.getAllReports();
    
    const stats = {
      totalTests: reports.length,
      averageScore: reports.length > 0 
        ? Math.round(reports.reduce((sum, r) => sum + r.summary.averageScore, 0) / reports.length)
        : 0,
      deviceStats: {} as Record<string, {
        totalTests: number;
        passRate: number;
        avgScore: number;
      }>,
      recent: reports
        .sort((a, b) => b.startTime.getTime() - a.startTime.getTime())
        .slice(0, 10)
        .map(report => ({
          gameId: report.gameId,
          executionId: report.executionId,
          score: report.summary.averageScore,
          timestamp: report.startTime,
          deviceCount: report.summary.totalDevices
        }))
    };
    
    // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º
    reports.forEach(report => {
      report.results.forEach(result => {
        const deviceName = result.deviceProfile.name;
        if (!stats.deviceStats[deviceName]) {
          stats.deviceStats[deviceName] = {
            totalTests: 0,
            passRate: 0,
            avgScore: 0
          };
        }
        
        const deviceStat = stats.deviceStats[deviceName];
        deviceStat.totalTests++;
        deviceStat.passRate = ((deviceStat.passRate * (deviceStat.totalTests - 1)) + (result.success ? 100 : 0)) / deviceStat.totalTests;
        deviceStat.avgScore = ((deviceStat.avgScore * (deviceStat.totalTests - 1)) + (result.success ? 100 : 0)) / deviceStat.totalTests;
      });
    });
    
    res.json({
      success: true,
      data: stats
    });
    
  } catch (error) {
    res.status(500).json({
      success: false,
      error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏',
      message: error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
    });
  }
}));

// WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
router.get('/stream', asyncHandler(async (req: Request, res: Response) => {
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSE
  res.writeHead(200, {
    'Content-Type': 'text/event-stream',
    'Cache-Control': 'no-cache',
    'Connection': 'keep-alive',
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Cache-Control'
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –æ—Ç DeviceTestingService
  const suiteStartedHandler = (event: any) => {
    res.write(`data: ${JSON.stringify({ type: 'suite-started', data: event })}\n\n`);
  };

  const deviceTestingHandler = (event: any) => {
    res.write(`data: ${JSON.stringify({ type: 'device-testing', data: event })}\n\n`);
  };

  const deviceCompletedHandler = (event: any) => {
    res.write(`data: ${JSON.stringify({ type: 'device-completed', data: event })}\n\n`);
  };

  const suiteCompletedHandler = (event: any) => {
    res.write(`data: ${JSON.stringify({ type: 'suite-completed', data: event })}\n\n`);
  };

  // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è
  deviceTestingService.on('suite:started', suiteStartedHandler);
  deviceTestingService.on('device:testing', deviceTestingHandler);
  deviceTestingService.on('device:completed', deviceCompletedHandler);
  deviceTestingService.on('suite:completed', suiteCompletedHandler);

  // Cleanup –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
  req.on('close', () => {
    deviceTestingService.off('suite:started', suiteStartedHandler);
    deviceTestingService.off('device:testing', deviceTestingHandler);
    deviceTestingService.off('device:completed', deviceCompletedHandler);
    deviceTestingService.off('suite:completed', suiteCompletedHandler);
    res.end();
  });

  // Keep-alive ping
  const keepAlive = setInterval(() => {
    res.write('data: {"type":"ping","timestamp":"' + new Date().toISOString() + '"}\n\n');
  }, 30000);

  req.on('close', () => {
    clearInterval(keepAlive);
  });
}));

export default router; 